---
title: "Lab09NotTeamOne"
author: "David Orozco, Ethan Schacht, Ryan Tate, Anderson Mun, Arie del Valle"
date: "March 14, 2019"
output: html_document
---


```{r,echo=FALSE, warning=FALSE,include=FALSE}


# Lab setup/test

#install.packages("tidyverse")
library(tidyverse)
library(lubridate)
#install.packages("OpenStreetMap")
library(OpenStreetMap)
library(ggplot2)
locations <- read.csv("Nice_Ride_2017_Station_Locations.csv")

trip <- read.csv("Nice_ride_trip_history_2017_season.csv")

```
```{r,echo=FALSE,message=FALSE,include=FALSE}

locations <- read_csv("Nice_Ride_2017_Station_Locations.csv")
rides <- read_csv("Nice_ride_trip_history_2017_season.csv")

merged <- left_join(rides, locations, by = c("Start station number" = "Number")) %>%
  left_join(locations, by = c("End station number" = "Number")) %>%
  mutate(start_latitude = `Latitude.x`, start_longitude = `Longitude.x`, start_total_docks = `Total docks.x`) %>%
  mutate(end_latitude = `Latitude.y`, end_longitude = `Longitude.y`, end_total_docks = `Total docks.y`) %>%
  select(-`Name.x`, -`Name.y`, -`Latitude.x`, -`Longitude.x`, -`Total docks.x`, -`Latitude.y`, -`Longitude.y`, -`Total docks.y`)

merged <- merged[c(1:3, 9:11, 4:6, 12:14, 7:8)]
```
```{r,echo=FALSE,error=FALSE,warning=FALSE,include=FALSE}
# Set latitudes and longitudes of city map
LAT1 <- 44.88     # Do not change
LAT2 <- 45.05     # Do not change
LON1 <- -93.35    # Do not change
LON2 <- -93.08    # Do not change

# Generate map
map <- openmap(c(LAT2,LON1), c(LAT1,LON2), zoom = NULL, # Can change zoom
               type = "esri",                           # Can change
               mergeTiles = TRUE)                       # Do not change

# Project map to latitude and longitude
map.latlon <- openproj(map, projection = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs") # Do not change

# Plot map of Minneapolis
autoplot(map.latlon) # Plots a map 

# Plot all niceride stations
# If you are not plotting the map, use ggplot() instead of autoplot
#ggplot() +
autoplot(map.latlon) + # Plots a map 
  geom_point(data=locations, 
               aes(x=Longitude, y=Latitude), 
               color = 'blue', size = 1) +
  labs(x='Longitude', y='Latitude') +
  ggtitle('Locations of NiceRide Stations')
```
```{r,echo=FALSE} 
trip <- merged %>% separate(`Start date` , into = c("date","time"),sep = " ") %>% separate(time,into = c("hour","minute"),sep = ":")

trip$date <- mdy(trip$date) 
trip$hour <- parse_integer(trip$hour)
trip$minute <- parse_integer(trip$minute)

```
```{r,echo=FALSE,warning=FALSE,message=FALSE,include=FALSE}
hallo <- trip %>% filter(date == '2017-10-31',hour < 8)
# Plot rides for halloween morning
#ggplot() +
autoplot(map.latlon) + # Plots a map 
  geom_segment(data=hallo, 
               aes(x=start_longitude, y=start_latitude,
                   xend=end_longitude, yend=end_latitude), 
               color = 'blue', size = .5,
               arrow = arrow(length = unit(0.2, "cm"))) +
  labs(x='Longitude', y='Latitude') +
  scale_x_continuous(limits = c(-93.3, -93.2)) +
  scale_y_continuous(limits = c(44.93, 45.02)) +
  ggtitle('Halloween Morning Rides')
```


****
#### David's Section
**** 
Question: How long do people keep bikes with NiceRide in terms of duration(time) and date-time??

```{r,echo=FALSE}
# trying to find average distance(in coordinates traveled)

lat <- merged %>% select(c(1,4,5,7,10,11,14)) %>% mutate(chnglat = abs(start_latitude-end_latitude), chnglong = abs(start_longitude-end_longitude)) %>% separate(`Start date`, into = c("dateint","timeint"),sep = " ") %>% separate(`End date`,into = c("dateend","timeend"),sep = " ") %>% separate(timeend,into = c("hourend","minuteend"),sep = ":") %>% separate(timeint,into = c("hourint","minuteint"),sep = ":") 

lat$dateint <- mdy(lat$dateint)
lat$dateend <- mdy(lat$dateend)

#str <- lat[,c(1:5)]
#str$dateint <- mdy(str$dateint)
#str <- str%>% mutate(day = strftime(str$dateint, format = "%j"))
                          
#end <- lat[,c(6:13)] %>% rename("dateint" = "dateend")
#x <- str %>% inner_join(end, by = "dateint")

#str$hourint <- parse_integer(str$hourint)
#end$hourint <- parse_integer(end$hourint)

#x <- end %>% inner_join(str, by = "dateint")
#lat %>% count(dateint == dateend) %>% filter(n > 1)
#lat %>% count(hourint == hourend) %>% filter(n > 1)

returns <- lat %>% count(dateint == dateend, hourint == hourend) %>% filter(n > 1)
returns <- returns %>% mutate(percent = n/sum(returns$n))%>% mutate(SameDayReturn = `dateint == dateend`,SameHourReturn = `hourint == hourend`) %>% arrange(desc(percent))

returns <- returns[,c(5,6,3,4)]
returns

#shows people who rent over nights(two days technically)
#gg <- trip %>% filter(hour == 23) %>% arrange(desc(minute))

```

```{r,echo=FALSE,warning=FALSE}
kkk <- lat %>% separate(dateint, into = c("year","month","day"),sep = "-") %>% unite("date",1:3,sep = "") %>% separate(dateend, into = c("year1","month1","day1"),sep = "-") %>% unite("datef",6:8,sep = "")
kkk$date <- parse_integer(kkk$date)
kkk$datef <- parse_integer(kkk$datef)
kkk <- as.tibble(kkk)

fff <- kkk[,1] %>% rename("datef" = "date")
fff <- as.tibble(fff)

# I dont understand why this doesnt work
#x4 <- fff %>% inner_join(kkk, by = "datef")

```
Note : `samedayreturn = false` includes those who rented before midnight and returns after midnight. This is not based on time (24hr) but on date.

* The tibble above shows the amount of NiceRide users depending on when they rented and returned thier bikes. Most users (~ 70%) rent and return thier bikes on the same day and hour. About 29% of users rent and return on the same day but return in during a different hour. The minority of the users, less than .02 percent, return thier bikes at the same time on different days. 


The graphs below are based on time. Also, it is composed of 434,696 NiceRide users who rent thier bikes for less than hour. 

```{r,echo=FALSE}

onehour <- lat %>% mutate(minute = `Total duration (Seconds)`/60) %>%  filter(minute < 60 ) %>% arrange(desc(minute))
oneday <- lat %>% mutate(hour = `Total duration (Seconds)`/3600) %>%  filter(hour >= 1,hour < 24 ) %>% arrange(desc(hour))

moredays <- lat %>% mutate( hour = `Total duration (Seconds)`/3600) %>% mutate(days = hour/24) %>% filter(days >= 1,days < 7 ) %>% arrange(desc(days))

moreweeks <- lat %>% mutate( hour = `Total duration (Seconds)`/3600) %>% mutate(days = hour/24) %>% mutate(weeks = days/7) %>% filter(weeks >= 1)%>% arrange(desc(weeks))
```
****
```{r,echo=FALSE}
ggplot(data = onehour, mapping = aes(x = minute)) + geom_density()
count(onehour)

onehour %>% filter(minute < 10) %>% summarise(mean = mean(minute))
```

* From all the NiceRide users who rent a bike for less than an hour, 6 minute is the average session length.

Methods: I used `left_join` to merge the location and ride dataset in order to be able to plot latitude and logitude along with date. I used `separate` to spit the date and times for `Start Date` and `End date`. I also used a tactic described in chapter 13 to find the amount of 'repeats'. So I was able to find when `dateint == dateend` and/or `hourint == hourend`. I used the `myd()` function to format the character entries for date into a date format. Along with that function I used other `parse` functions to reformat the entries. `returns <- returns[,c(5,6,3,4)]` was used in place of `select` to elect the columns that were under study. Finally, I used `filter` commands and `geom_density` to show the distribution in duration of bikes rented.



****
```{r,echo=FALSE,include=FALSE}
ggplot(data = oneday, mapping = aes(x = hour)) + geom_density()
count(oneday)
ggplot(data = moredays, mapping = aes(x = days)) + geom_density()
count(moredays)
ggplot(data = moreweeks, mapping = aes(x = weeks)) + geom_density()
count(moreweeks)
```

**** 
#### Arie's Section
****

**** 
#### Anderson's Section
****

* Question: What is the average duration a rider stays on their bike per month?
```{r,echo=FALSE}
Start_date <- merged %>%
  separate(`Start date`, into = c("Date", "Time"), sep = " ")
Start_date$`Date` <- mdy(Start_date$`Date`)
Start_date$`Time` <- mdy(Start_date$`Time`)  

A <- Start_date %>% 
  group_by(`Date`) %>%
  summarise(Average_Duration_per_day = mean(`Total duration (Seconds)`)) %>%
  filter(Average_Duration_per_day < 5000)


ggplot(data = A) +
  geom_smooth(mapping = aes(x = `Date`, y = `Average_Duration_per_day`)) +
  geom_point(mapping = aes(x = `Date`, y = `Average_Duration_per_day`)) +
  ylab("Average Duration (seconds)") +
  ggtitle("Average Time Spent Riding per Month")
```
* I first set my data equal to a new variable I called start_date. I altered this variable by seperating the time/date variable and parsing it into date and time. The next thing I did with my data was looking for the average duration on the bike per month. I filtered, grouped and summarised my data to find this. Finally I plotted the data into a graph showing the trend line of duration spent on the bike throughout the year.

* In my finding I found out that the least amount of time spent riding a bike were during the coldest and latest months of the year. During the months in the middle of the year bikers on average had the longest duration.

**** 
#### Ethan's Section
****
* Question: How often do people use the Nice Ride depending on the day of week, and how
does this vary by account type?


```{r,echo=FALSE}

merged$`Start date` <- mdy_hm(merged$`Start date`)
merged$`End date` <- mdy_hm(merged$`End date`)

nice_ride <- merged %>%
  mutate(week_day = wday(`Start date`, label = TRUE)) %>%
  filter(`Account type` != "Inconnu")

ggplot(data = nice_ride) +
  geom_bar(mapping = aes(x = week_day, fill = `Account type`), position = "dodge") +
  xlab("Day of Week") +
  ylab("Count") +
  ggtitle("Distribution of Rides Throughout Week by Account Type")

week_stats <- nice_ride %>%
  group_by(week_day, `Account type`) %>%
  summarise(count = n())

```

* Methods: I first used `left_join` to combine the locations dataset with the overall rides
dataset, and then changed some variable names and sorted based on if the variables described
starting location or ending location.  I then parsed by times into `mdy_hm` and used `w_day`
to make a variable describing the day of week.  For the graph, used geom_bar to plot day
of week against count of rides for that day of week, filling with Account Type and using `dodge`
to compare the different memberships side-by-side for each day.  To get stats from this graph,
I grouped by the week day and account type and counted occurances of each combination.

* Findings: Most people tend to utilize the Nice Rides on the weekends, and this makes sense
because people tend to have more free time on these days.  Interestingly, member account 
types far outnumber casual account types on the weekdays, but casual account types outweigh
member account types on the weekends.  This is likely due to the fact that people who pay for
the membership are likely doing so because they also need it on the weekdays, perhaps to 
regularly commute to work, whereas casual riders who may be using the service for more 
leisurely reasons on the weekends don't as strongly require a regular membership.

* Stats: 
1. The most common riding day is Saturday, with a total of over 80,000 rides
2. Totals of at least 40,000 rides are taken by members on each week day, and totals of less
   than 20,000 rides are taken by casual members each weekday unless it's Friday
   
**** 
#### Ryan's Section
****